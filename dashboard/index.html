<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Queue Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            position: relative;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            font-size: 14px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-number {
            font-size: 36px;
            font-weight: bold;
            margin: 10px 0;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
            text-transform: uppercase;
        }

        .stat-card.total { border-top: 4px solid #667eea; }
        .stat-card.pending { border-top: 4px solid #ffa502; }
        .stat-card.processing { border-top: 4px solid #3742fa; }
        .stat-card.completed { border-top: 4px solid #2ed573; }
        .stat-card.failed { border-top: 4px solid #ff4757; }

        .stat-card.total .stat-number { color: #667eea; }
        .stat-card.pending .stat-number { color: #ffa502; }
        .stat-card.processing .stat-number { color: #3742fa; }
        .stat-card.completed .stat-number { color: #2ed573; }
        .stat-card.failed .stat-number { color: #ff4757; }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .card h2 {
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
            font-family: monospace;
        }

        button {
            background: #667eea;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        button:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .jobs-table {
            width: 100%;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #f0f0f0;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            display: inline-block;
        }

        .status-pending { background: #fff3cd; color: #856404; }
        .status-processing { background: #cfe2ff; color: #084298; }
        .status-completed { background: #d1e7dd; color: #0f5132; }
        .status-failed { background: #f8d7da; color: #842029; }
        .status-retrying { background: #e2e3e5; color: #383d41; }

        .queue-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            transition: all 0.3s ease;
        }

        .queue-info:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .message {
            padding: 12px;
            border-radius: 5px;
            margin-bottom: 15px;
            display: none;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.success {
            background: #d1e7dd;
            color: #0f5132;
            border: 1px solid #badbcc;
        }

        .message.error {
            background: #f8d7da;
            color: #842029;
            border: 1px solid #f5c2c7;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #2ecc71;
            color: white;
            padding: 12px 24px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            animation: slideIn 0.3s ease-out;
            z-index: 1000;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Connection status styles */
        #connection-status {
            position: absolute;
            top: 20px;
            right: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>🚀 Distributed Job Queue Dashboard</h1>
            <p class="subtitle">Monitor and manage your job queue system</p>
            <span id="connection-status" class="status-badge status-pending">Connecting...</span>
        </div>

        <!-- Statistics -->
        <div class="stats-grid">
            <div class="stat-card total">
                <div class="stat-label">Total Jobs</div>
                <div class="stat-number" id="stat-total">0</div>
            </div>
            <div class="stat-card pending">
                <div class="stat-label">Pending</div>
                <div class="stat-number" id="stat-pending">0</div>
            </div>
            <div class="stat-card processing">
                <div class="stat-label">Processing</div>
                <div class="stat-number" id="stat-processing">0</div>
            </div>
            <div class="stat-card completed">
                <div class="stat-label">Completed</div>
                <div class="stat-number" id="stat-completed">0</div>
            </div>
            <div class="stat-card failed">
                <div class="stat-label">Failed</div>
                <div class="stat-number" id="stat-failed">0</div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Submit Job Form -->
            <div class="card">
                <h2>➕ Submit New Job</h2>
                <div id="form-message" class="message"></div>
                
                <form id="job-form">
                    <div class="form-group">
                        <label for="task-name">Task Type</label>
                        <select id="task-name" required>
                            <option value="">Select a task...</option>
                            <!-- Communication Tasks -->
                            <option value="send_email">Send Email</option>
                            <option value="send_sms">Send SMS</option>
                            
                            <!-- Data Processing Tasks -->
                            <option value="process_image">Process Image</option>
                            <option value="analyze_data">Analyze Data</option>
                            
                            <!-- File Operations -->
                            <option value="generate_report">Generate Report</option>
                            <option value="backup_database">Backup Database</option>
                            
                            <!-- Machine Learning -->
                            <option value="train_model">Train ML Model</option>
                            
                            <!-- System Maintenance -->
                            <option value="clean_logs">Clean Logs</option>
                            <option value="system_health_check">System Health Check</option>
                        </select>
                    <div class="form-group">
                        <label for="task-data">Task Data (JSON)</label>
                        <textarea id="task-data" placeholder='{"key": "value"}' required></textarea>
                    </div>

                    <div class="form-group">
                        <label for="queue">Queue</label>
                        <select id="queue">
                            <option value="default">Default</option>
                            <option value="high">High Priority</option>
                            <option value="low">Low Priority</option>
                        </select>
                    </div>

                    <button type="submit">Submit Job</button>
                </form>
            </div>

            <!-- Queue Status -->
            <div class="card">
                <h2>📊 Queue Status</h2>
                <div id="queue-loading" class="loading">Loading...</div>
                <div id="queue-status" style="display: none;">
                    <div class="queue-info">
                        <span><strong>High Priority:</strong></span>
                        <span id="queue-high">0</span>
                    </div>
                    <div class="queue-info">
                        <span><strong>Default:</strong></span>
                        <span id="queue-default">0</span>
                    </div>
                    <div class="queue-info">
                        <span><strong>Low Priority:</strong></span>
                        <span id="queue-low">0</span>
                    </div>
                    <div class="queue-info" style="background: #667eea; color: white; font-weight: bold;">
                        <span>Total in Queues:</span>
                        <span id="queue-total">0</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Jobs -->
        <div class="card full-width">
            <h2>📋 Recent Jobs</h2>
            <div class="jobs-table">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Task</th>
                            <th>Status</th>
                            <th>Created</th>
                            <th>Duration</th>
                            <th>Worker</th>
                        </tr>
                    </thead>
                    <tbody id="jobs-tbody">
                        <tr>
                            <td colspan="6" class="loading">Loading jobs...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

        <!-- Socket.IO client -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>

    <!-- Dashboard JavaScript -->
    <script>
        const API_URL = 'http://localhost:5000/api';
        const socket = io();

        // Socket.IO Connection Events
        socket.on('connect', () => {
            console.log('✅ Connected to WebSocket');
            document.getElementById('connection-status').textContent = 'Connected';
            document.getElementById('connection-status').className = 'status-badge status-completed';
            // Load initial data
            loadInitialData();
        });

        socket.on('disconnect', () => {
            console.log('❌ Disconnected from WebSocket');
            document.getElementById('connection-status').textContent = 'Disconnected';
            document.getElementById('connection-status').className = 'status-badge status-failed';
        });

        // WebSocket Events
        socket.on('stats', (data) => {
            console.log('📊 Stats Update:', data);
            if (data.stats) {
                updateStats(data.stats);
            }
        });

        socket.on('queues', (data) => {
            console.log('📋 Queue Update:', data);
            if (data.queues) {
                updateQueueStatus(data.queues);
            }
        });

        socket.on('jobs', (data) => {
            console.log('📦 Jobs Update:', data);
            if (data.jobs) {
                updateJobsTable(data.jobs);
            }
        });

        // Update Functions
        function updateStats(stats) {
            document.getElementById('stat-total').textContent = stats.total || 0;
            document.getElementById('stat-pending').textContent = stats.pending || 0;
            document.getElementById('stat-processing').textContent = stats.processing || 0;
            document.getElementById('stat-completed').textContent = stats.completed || 0;
            document.getElementById('stat-failed').textContent = stats.failed || 0;
        }

        function updateQueueStatus(queues) {
            document.getElementById('queue-high').textContent = queues.high || 0;
            document.getElementById('queue-default').textContent = queues.default || 0;
            document.getElementById('queue-low').textContent = queues.low || 0;
            document.getElementById('queue-total').textContent = 
                (queues.high || 0) + (queues.default || 0) + (queues.low || 0);
            
            document.getElementById('queue-loading').style.display = 'none';
            document.getElementById('queue-status').style.display = 'block';
        }

        function updateJobsTable(jobs) {
            const tbody = document.getElementById('jobs-tbody');
            if (jobs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="loading">No jobs yet</td></tr>';
                return;
            }

            tbody.innerHTML = jobs.map(job => `
                <tr id="job-${job.id}">
                    <td>${job.id.substring(0, 8)}...</td>
                    <td>${job.task_name}</td>
                    <td><span class="status-badge status-${job.status}">${job.status}</span></td>
                    <td>${new Date(job.created_at).toLocaleString()}</td>
                    <td>${job.execution_time ? job.execution_time.toFixed(2) + 's' : '-'}</td>
                    <td>${job.worker_id || '-'}</td>
                </tr>
            `).join('');
        }

        // Form Submission
        document.getElementById('job-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formMessage = document.getElementById('form-message');
            const submitButton = e.target.querySelector('button[type="submit"]');
            
            try {
                const taskData = JSON.parse(document.getElementById('task-data').value);
                
                const jobData = {
                    task_name: document.getElementById('task-name').value,
                    task_data: taskData,
                    queue: document.getElementById('queue').value
                };
                
                submitButton.disabled = true;
                submitButton.textContent = 'Submitting...';
                
                const response = await fetch(`${API_URL}/jobs`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(jobData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    formMessage.className = 'message success';
                    formMessage.textContent = `✅ Job submitted successfully! ID: ${result.job_id.substring(0, 8)}...`;
                    formMessage.style.display = 'block';
                    
                    // Clear form
                    document.getElementById('job-form').reset();
                    
                    // Hide message after 5 seconds
                    setTimeout(() => {
                        formMessage.style.display = 'none';
                    }, 5000);
                } else {
                    throw new Error(result.error || 'Failed to submit job');
                }
                
            } catch (error) {
                formMessage.className = 'message error';
                formMessage.textContent = `❌ Error: ${error.message}`;
                formMessage.style.display = 'block';
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Submit Job';
            }
        });

        // Task Data Examples
        document.getElementById('task-name').addEventListener('change', (e) => {
            const taskData = document.getElementById('task-data');
            const examples = {
                'send_email': '{\n  "to": "professor@university.edu",\n  "subject": "Demo Email",\n  "attachments": ["report.pdf", "data.xlsx"]\n}',
                
                'send_sms': '{\n  "phone": "+1234567890",\n  "message": "System alert: Processing completed!"\n}',
                
                'process_image': '{\n  "image_url": "demo_image.jpg",\n  "operations": ["resize", "compress", "filter"]\n}',
                
                'analyze_data': '{\n  "dataset": [10, 20, 30, 40, 50, 60, 70],\n  "analyses": ["mean", "median", "std_dev"]\n}',
                
                'generate_report': '{\n  "report_type": "performance",\n  "user_id": 123,\n  "format": "pdf"\n}',
                
                'backup_database': '{\n  "database": "university_records",\n  "type": "full"\n}',
                
                'train_model': '{\n  "model_type": "neural_network",\n  "dataset_size": 1000,\n  "epochs": 10\n}',
                
                'clean_logs': '{\n  "days_old": 30,\n  "log_type": "application_logs"\n}',
                
                'system_health_check': '{\n  "components": ["cpu", "memory", "disk", "network"]\n}'
            };
            
            if (e.target.value && examples[e.target.value]) {
                taskData.value = examples[e.target.value];
            }
        });

        // Initial Data Load
        async function loadInitialData() {
            try {
                // Load stats
                const statsResponse = await fetch(`${API_URL}/stats`);
                const statsData = await statsResponse.json();
                if (statsData.success) {
                    updateStats(statsData.stats);
                }

                // Load queue status
                const queuesResponse = await fetch(`${API_URL}/queues`);
                const queuesData = await queuesResponse.json();
                if (queuesData.success) {
                    updateQueueStatus(queuesData.queues);
                }

                // Load recent jobs
                const jobsResponse = await fetch(`${API_URL}/jobs?limit=20`);
                const jobsData = await jobsResponse.json();
                if (jobsData.success) {
                    updateJobsTable(jobsData.jobs);
                }
            } catch (error) {
                console.error('Error loading initial data:', error);
                showNotification('❌ Error loading data');
            }
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Load initial data
        loadInitialData();
    </script>
</body>
</html>